name: Node CI - Simple Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install
        working-directory: ./api

      - name: Start API and run test
        run: |
          npm start &                # inicia a API em background
          npx wait-on http://localhost:8080
          node tests/teste_index.js  # roda o seu teste
        working-directory: ./api
   
    docker-build-and-push:
      needs: build-and-test
      runs-on: ubuntu-latest
      steps:
        - name: Checkout repo
          uses: actions/checkout@v3

        - name: Log in to AWS ECR
          uses: aws-actions/amazon-ecr-login@v2

        - name: Build Docker image
          run: |
            docker build -t my-app:${{ github.sha }} ./api
            docker tag my-app:${{ github.sha }} 127854692881.dkr.ecr.us-east-2.amazonaws.com/homelab:${{ github.sha }}

        - name: Push Docker image to ECR
          run: |
            docker push 127854692881.dkr.ecr.us-east-2.amazonaws.com/homelab:${{ github.sha }}
